#!/bin/bash

NEARBY_GO_CONFIG=$(dirname "$BASH_SOURCE[0]")/sphere-go-config
WHICH_GO_CONFIG=$(which sphere-go-config 2>/dev/null)
GOPATH_GO_CONFIG=$GOPATH/bin/sphere-go-config

# interpolate --cloud-production argument according to value of /etc/ninja-release
EXTRA_ARG=$(
	export NINJA_OS_BUILD_TARGET= &&
	test -f /etc/ninja-release &&
	. /etc/ninja-release &&
	TARGET_BRANCH=$(echo $NINJA_OS_BUILD_TARGET | cut -d'-' -f2) &&
	case "$TARGET_BRANCH" in
	testing|stable)
		echo "--cloud-production"
	;;
	*)
		:
	;;
	esac
)

if test -x "$WHICH_GO_CONFIG"; then
    GO_CONFIG=$WHICH_GO_CONFIG
elif test -x "$NEARBY_GO_CONFIG"; then
    GO_CONFIG=$NEARBY_GO_CONFIG
elif test -x "$GOPATH_GO_CONFIG"; then
    GO_CONFIG=$GOPATH_GO_CONFIG
else
    echo "cannot find sphere-go-config on path" 1>&2
fi

"$GO_CONFIG" $EXTRA_ARG "$@"
